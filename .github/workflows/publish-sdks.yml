name: Publish SDKs

on:
  workflow_dispatch:
    inputs:
      sdk:
        description: 'Which SDK to publish'
        required: true
        type: choice
        options:
          - typescript
          - javascript
          - python
          - all
      version_bump:
        description: 'Version bump type (patch/minor/major) or skip'
        required: false
        default: 'skip'
        type: choice
        options:
          - skip
          - patch
          - minor
          - major

jobs:
  publish-typescript:
    name: Publish TypeScript SDK
    runs-on: ubuntu-latest
    if: inputs.sdk == 'typescript' || inputs.sdk == 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Bump version
        if: inputs.version_bump != 'skip'
        working-directory: apps/sdks/ts
        run: npm version ${{ inputs.version_bump }} --no-git-tag-version

      - name: Install dependencies and build
        working-directory: apps/sdks/ts
        run: |
          npm install
          npm run generate
          npm run build

      - name: Publish to npm
        working-directory: apps/sdks/ts
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-javascript:
    name: Publish JavaScript SDK
    runs-on: ubuntu-latest
    if: inputs.sdk == 'javascript' || inputs.sdk == 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Bump version
        if: inputs.version_bump != 'skip'
        working-directory: apps/sdks/js
        run: npm version ${{ inputs.version_bump }} --no-git-tag-version

      - name: Install dependencies and build
        working-directory: apps/sdks/js
        run: |
          npm install
          npm run generate
          npm run build

      - name: Publish to npm
        working-directory: apps/sdks/js
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-python:
    name: Publish Python SDK
    runs-on: ubuntu-latest
    if: inputs.sdk == 'python' || inputs.sdk == 'all'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Bump version (if specified)
        if: inputs.version_bump != 'skip'
        working-directory: apps/sdks/python
        run: |
          # Simple version bumping for setup.py
          python -c "
          import re
          with open('setup.py', 'r') as f:
              content = f.read()
          version = re.search(r'VERSION = \"([^\"]+)\"', content).group(1)
          major, minor, patch = map(int, version.split('.'))
          bump_type = '${{ inputs.version_bump }}'
          if bump_type == 'major':
              major += 1
              minor = 0
              patch = 0
          elif bump_type == 'minor':
              minor += 1
              patch = 0
          elif bump_type == 'patch':
              patch += 1
          new_version = f'{major}.{minor}.{patch}'
          content = re.sub(r'VERSION = \"[^\"]+\"', f'VERSION = \"{new_version}\"', content)
          with open('setup.py', 'w') as f:
              f.write(content)
          print(f'Bumped version from {version} to {new_version}')
          "

      - name: Build package
        working-directory: apps/sdks/python
        run: python -m build

      - name: Check package
        working-directory: apps/sdks/python
        run: twine check dist/*

      - name: Publish to PyPI
        working-directory: apps/sdks/python
        run: twine upload dist/*
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
