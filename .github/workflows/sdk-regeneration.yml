name: SDK Regeneration

on:
  # Manual trigger - always available
  workflow_dispatch:
    inputs:
      sdk_filter:
        description: 'Which SDKs to regenerate (all/ts/js/python/go/php/laravel)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - ts
          - js
          - python
          - go
          - php
          - laravel
  
  # Automatic trigger on spec.yaml changes - controlled by variable
  push:
    paths:
      - 'apps/sdks/spec.yaml'
    branches:
      - main

env:
  # Toggle this to enable/disable automatic regeneration
  AUTO_REGENERATE_ENABLED: 'false'

jobs:
  check-auto-trigger:
    name: Check Auto-Trigger Status
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check if auto-regeneration is enabled
        id: check
        run: |
          if [ "${{ env.AUTO_REGENERATE_ENABLED }}" = "true" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Auto-regeneration is ENABLED"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Auto-regeneration is DISABLED - skipping workflow"
          fi

  regenerate-sdks:
    name: Regenerate SDKs
    runs-on: ubuntu-latest
    needs: [check-auto-trigger]
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && needs.check-auto-trigger.outputs.should_run == 'true')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install OpenAPI Generator
        run: |
          npm install -g @openapitools/openapi-generator-cli

      - name: Generate TypeScript SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'ts' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating TypeScript SDK..."
          node scripts/typescript-generate.js
          cd ts && npm install && npm run build

      - name: Generate JavaScript SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'js' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating JavaScript SDK..."
          node scripts/javascript-generate.js
          cd js && npm install && npm run build

      - name: Generate Python SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'python' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating Python SDK..."
          node scripts/python-generate.js
          cd python && python -m pip install build twine && python -m build

      - name: Generate Go SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'go' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating Go SDK..."
          node scripts/go-generate.js

      - name: Generate PHP SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'php' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating PHP SDK..."
          node scripts/php-generate.js
          cd php && composer install

      - name: Generate Laravel SDK
        if: inputs.sdk_filter == 'all' || inputs.sdk_filter == 'laravel' || github.event_name == 'push'
        working-directory: apps/sdks
        run: |
          echo "üî® Generating Laravel SDK..."
          node scripts/laravel-generate.js
          cd laravel && composer install

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: regenerate SDKs from spec.yaml'
          branch: sdk-regeneration-${{ github.run_number }}
          title: 'ü§ñ Regenerate SDKs from spec.yaml'
          body: |
            ## SDK Regeneration
            
            This PR was automatically generated by the SDK regeneration workflow.
            
            **Trigger:** ${{ github.event_name == 'workflow_dispatch' && 'Manual' || 'spec.yaml update' }}
            **SDKs Updated:** ${{ inputs.sdk_filter || 'all' }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please review the changes before merging.
          labels: |
            automated
            sdk
          assignees: ${{ github.actor }}
